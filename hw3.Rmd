---
title: "Homework 3"
author: "Zichen Luo"
fontsize: 12pt
output:
  html_document:
    df_print: paged
urlcolor: black
geometry: margin=1in
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

## Problem 1

### Part a
```{r}
# Save parameter values as objects
mu <- 73.2
sigma <- 4.9
alpha <- 0.05
```

### Part b
```{r}
# Function to conduct z-test
my.test <- function(n) {
  # Generate sample
  sample_data <- rnorm(n, mean = mu, sd = sigma)
  
  # Calculate sample mean
  sample_mean <- mean(sample_data)
  
  # Calculate z-statistic
  z_stat <- (sample_mean - mu) / (sigma / sqrt(n))
  
  # Calculate critical values for two-tailed test
  z_critical <- qnorm(1 - alpha/2)
  
  # Test if we reject null hypothesis
  reject <- abs(z_stat) > z_critical
  
  return(reject)
}

# Test the function with a few sample sizes
my.test(10)
my.test(25)
my.test(50)
```

### Part c
```{r}
# Execute function 10,000 times with sample size 23
results <- replicate(10000, my.test(23))
propReject <- mean(results)
propReject
```

### Part d
```{r}
# Theoretical proportion (Type I error rate)
trueFalsePositiveRate <- alpha
trueFalsePositiveRate
```

### Part e
```{r}
# Function to get proportion for given sample size
rep.z <- function(n) {
  num_simulations <- 10000
  results <- replicate(num_simulations, my.test(n))
  return(mean(results))
}

# Execute for sample sizes 8, 23, and 52
rep.z(8)
rep.z(23)
rep.z(52)
```

### Part f
```{r}
# Execute for sample sizes 3 through 52
sample_sizes <- 3:52
myResults <- sapply(sample_sizes, rep.z)
```

### Part g
```{r}
# Analyze the trend
# Check if all proportions are close to trueFalsePositiveRate
# Consider "close" as within 2 standard errors of the expected value
# Standard error for proportion: sqrt(p(1-p)/n) where n is number of simulations
se <- sqrt(trueFalsePositiveRate * (1 - trueFalsePositiveRate) / 10000)
tolerance <- 2 * se

allClose <- all(abs(myResults - trueFalsePositiveRate) <= tolerance)
allClose
```

## Problem 2

### Part a
```{r}
# Read in the data file
nym2021 <- read.table("nym2021.txt", header = TRUE, stringsAsFactors = FALSE)
head(nym2021)
```

### Part b
```{r}
# Number of finishers
numFinishers <- nrow(nym2021)
numFinishers
```

### Part c
```{r}
# US states and territories
us_states_territories <- c("AL", "AK", "AZ", "AR", "CA", "CO", "CT", "DE", "FL", "GA", 
                          "HI", "ID", "IL", "IN", "IA", "KS", "KY", "LA", "ME", "MD", 
                          "MA", "MI", "MN", "MS", "MO", "MT", "NE", "NV", "NH", "NJ", 
                          "NM", "NY", "NC", "ND", "OH", "OK", "OR", "PA", "RI", "SC", 
                          "SD", "TN", "TX", "UT", "VT", "VA", "WA", "WV", "WI", "WY", 
                          "DC", "PR", "VI", "GU", "AS", "MP")

numUSAFinishers <- sum(nym2021$HomeStateOrCountry %in% us_states_territories)
numUSAFinishers
```

### Part d
```{r}
# Create modified country column
country_column <- ifelse(nym2021$HomeStateOrCountry %in% us_states_territories, 
                        "USA", 
                        nym2021$HomeStateOrCountry)

numEachCountry <- table(country_column)
numEachCountry
```

### Part e
```{r}
# Number of unique countries
numUniqueCountries <- length(numEachCountry)
numUniqueCountries
```

### Part f
```{r}
# Age of youngest and oldest finishers
oldestAndYoungest <- c(min(nym2021$Age), max(nym2021$Age))
oldestAndYoungest
```

### Part g
```{r}
# Division of fastest and slowest finishers
fastest_index <- which.min(nym2021$Time)
slowest_index <- which.max(nym2021$Time)

divFastest <- nym2021$DIV[fastest_index]
divSlowest <- nym2021$DIV[slowest_index]

divFastest
divSlowest
```

### Part h
```{r}
# Number of finishers outside Top 100 of their division
numOutside <- sum(nym2021$DivPlace > 100)
numOutside
```

### Part i
```{r}
# Divisions of Top 5 finishers in each division
top5_divisions <- nym2021$DIV[nym2021$DivPlace <= 5]
unique_top5_divs <- unique(top5_divisions)

# Sort divisions: female before male, young before old
# Extract gender and age info
gender_order <- ifelse(grepl("^F", unique_top5_divs), "F", "M")
age_ranges <- gsub("^[FM]", "", unique_top5_divs)

# Create sorting key
sorting_df <- data.frame(
  division = unique_top5_divs,
  gender = gender_order,
  age_range = age_ranges,
  stringsAsFactors = FALSE
)

# Sort by gender first, then by age range
sorted_indices <- order(sorting_df$gender, sorting_df$age_range)
divTopFive <- sorting_df$division[sorted_indices]
divTopFive
```

### Part j
```{r}
# Subset Top 50 overall finishers
top50 <- nym2021[nym2021$Place <= 50, ]
head(top50)
```

### Part k
```{r}
# Average age by Boston qualifier status
boston_yes <- nym2021$Age[nym2021$BostonQualifier == "Y"]
boston_no <- nym2021$Age[nym2021$BostonQualifier == "N"]

aveAges <- c(mean(boston_yes), mean(boston_no))
aveAges
```
